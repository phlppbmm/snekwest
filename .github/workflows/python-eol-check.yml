name: Python EOL Check

on:
  schedule:
    # Weekly on Monday at 08:00 UTC
    - cron: '0 8 * * 1'
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: read
  issues: write

jobs:
  check-python-eol:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract minimum Python version
        id: extract-version
        run: |
          MIN_PY=$(grep -oP 'requires-python\s*=\s*">=\K[0-9]+\.[0-9]+' pyproject.toml)
          echo "version=${MIN_PY}" >> "$GITHUB_OUTPUT"
          echo "Minimum Python version: ${MIN_PY}"

      - name: Check EOL status
        id: eol
        uses: sindrel/endoflife-github-action@v1
        with:
          product: python
          version: ${{ steps.extract-version.outputs.version }}
          fail_days_left: '90'

      - name: Create issue if approaching EOL
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.extract-version.outputs.version }}';
            const daysLeft = '${{ steps.eol.outputs.days_until_eol }}';
            const summary = '${{ steps.eol.outputs.text_summary }}';
            const title = `Python ${version} reaches EOL in ${daysLeft} days — plan version bump`;

            // Check if an open issue with the same title prefix already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'infra,p1-important'
            });
            const existing = issues.find(i => i.title.startsWith(`Python ${version} reaches EOL`));
            if (existing) {
              console.log(`Issue #${existing.number} already exists, skipping.`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: [
                `## Automated EOL Warning`,
                ``,
                `${summary}`,
                ``,
                `**Minimum supported version:** Python ${version}`,
                `**Days until EOL:** ${daysLeft}`,
                ``,
                `### Action required`,
                ``,
                `1. Bump \`requires-python\` in \`pyproject.toml\` to the next supported version`,
                `2. Update classifiers in \`pyproject.toml\``,
                `3. Run the full test suite against the new minimum version`,
                `4. Check that upstream \`requests\` still supports the same or fewer versions`,
                ``,
                `### Policy`,
                `> Follow CPython EOL dates — drop support for EOL versions with the next release.`,
                `> As a drop-in replacement for \`requests\`, never support fewer versions than upstream.`,
                ``,
                `*This issue was auto-created by the [Python EOL Check workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/python-eol-check.yml).*`
              ].join('\n'),
              labels: ['infra', 'p1-important']
            });

      - name: Log EOL status (success case)
        if: success()
        run: |
          echo "Python ${{ steps.extract-version.outputs.version }} EOL check passed."
          echo "${{ steps.eol.outputs.text_summary }}"
          echo "Days until EOL: ${{ steps.eol.outputs.days_until_eol }}"
